<html lang="en">
<head>
<link rel="stylesheet" type="text/css" href="css/style.css">
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/jquery.scrollTo-1.4.2-min.js"></script>
<script type="text/javascript" src="js/URI.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="js/api.js"></script>
<script type="text/javascript" src="flot/jquery.flot.js"></script>
<script type="text/javascript" src="flot/jquery.flot.time.js"></script>
<script type="text/javascript" src="flot/jquery.flot.navigate.js"></script>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-41905116-1', '1248.io');
ga('send', 'pageview');
</script>

<script>
function loadResource(url, key) {
    fetch(url, key, function(err, body) {
        if (!err) {
            var d = [];

            var poss_sections = Object.keys(body);
            var sections = [];
            for (var i=0;i<poss_sections.length;i++) {
                if (poss_sections[i].charAt(0) == '#')
                    sections.push(poss_sections[i]);
            }
            for (var i=0;i<sections.length;i++) {
                var poss_times = Object.keys(body[sections[i]]);
                var times = [];
                for (var j=0;j<poss_times.length;j++) {
                    if (poss_times[j] != 'common')
                        times.push(poss_times[j]);
                }
                log(sections[i] + "=" + JSON.stringify(times));
                var points = [];
                for (var k=0;k<times.length;k++) {
log(times[k]);
                    var timestamp = Date.parse(times[k]);
                    //log(JSON.stringify(  (body[sections[i]])[times[k]]  ));
                    var facts = (body[sections[i]])[times[k]];
                    for (var f=0;f<facts.length;f++) {
                        if (facts[f].rel == 'hasValue') {
                            log([sections[i], timestamp, facts[f].val]);
                            points.push([timestamp, parseFloat(facts[f].val)]);
                        }
                    }
                }
                if (points.length > 0)
                    d.push({label: sections[i], data: points});
            }
            if (d.length > 0) {
                var options = {
                    series: {
                        lines: { show: true },
                        points: { show: true }
                    },
                    xaxis: {
                        mode: "time"
                    },
                    zoom: {
                        interactive: true
                    },
                    pan: {
                        interactive: true
                    }
                };
                $.plot($('#chart'), d, options);
                //log(JSON.stringify(d));
            }
        }
    });
}

$(document).ready(function() { 
    var param_url = getQueryVariable('url');
    var param_key = getQueryVariable('key');
    if (param_key === undefined)
        param_key = "";

    $('#key').val(param_key);
    if (param_url !== undefined) {
        $('#url').val(param_url);
        log("loading resource "+param_url);
        loadResource($('#url').val(), $('#key').val());
    }

    $('#get').click(function() {
        loadResource($('#url').val(), $('#key').val());
    });
});

</script>
</head>

<body>
    <a href="http://1248.io"><img src="logo-32x32.png" style="float: right;" border=0></a>
    <h1>Generic Resource Viewer</h1>
    <hr>
    <p>
        URL&nbsp;<input type="text" id="url" size=80 value="https://alertmeadaptor.appspot.com/resources/armmeetingrooms/BOX.json" />
        Key&nbsp;<input type="text" id="key" size=40 value="" />
        <input type="button" id="get" value="Get" />
    </p>

    <p>
        <div id="chart" style="width:600px;height:300px;"></div>
    </p>

    <p>
        <div id="log"></div>
    </p>
</body>

</html>
