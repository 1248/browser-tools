<html>
<head>
<link rel="stylesheet" type="text/css" href="css/diQuery-collapsiblePanel.css">
<style type="text/css">
h1 {color:red;}
#log {
    height: 15%;
    width:100%; 
    padding:10px;
    background:#808080;
    overflow:scroll;
    font-family: monospace;
}
#canvascontainer {
    border: 2px solid black;
}
</style>
<script src="js/jquery-1.9.1.min.js"></script>
<script src="js/jquery.scrollTo-1.4.2-min.js"></script>
<script type="text/javascript" src="js/URI.js"></script>
<script type="text/javascript" src="js/springy.js"></script>
<script type="text/javascript" src="js/springyui.js"></script>
<script type="text/javascript" src="js/diQuery-collapsiblePanel.js"></script>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyDHADoA_flyLNzUs_W2TxuqF5EtDyZTpxM&sensor=true"></script>
<script>
var unexplored = [];
var explored = [];
var facts = [];
var graph, springy;
var infoWindows = {};
var map;
var markers = [];
var infowindow = new google.maps.InfoWindow({});


function log(msg) {
    var log = $('#log');
    log.append(msg + "<br/>\n");
    log.scrollTo('100%');
}

function populateExamples() {
    $("#examples").append(new Option("Select example URL", ""));

    $.ajax({
        type: 'GET',
        url: '/listexamples',
        dataType: 'json',
        success: function(body, textStatus, xhr) {
            for (var i=0;i<body.length;i++)
                $("#examples").append(new Option(body[i], body[i]));
        },
        error: function() {
            log("Error listing examples");
        }
    });
}

function fetch(url, cb) {
    log('-> GET ' + url);
    $.ajax({
        type: 'GET',
        url: '/fetch?url='+encodeURI(url),
        dataType: 'json',
        success: function(body, textStatus, xhr) {
            log('<- ' + xhr.status + ' ' + xhr.statusText);
            cb(null, body);
        },
        error: function() {
            log("Error fetching "+url);
        }
    });
}


function storeFact(o) {
    // only store unique facts (FIXME, slow)
    for (var i=0;i<facts.length;i++) {
        if (facts[i].subject == o.subject &&
            facts[i].predicate == o.predicate &&
            facts[i].object == o.object)
                return;
    }
    facts.push(o);
}

function expandCatalogue(url, doc) {
    try {
        // store metadata for catalogue
        for (var i=0;i<doc.metadata.length;i++) {
            //console.log("CATL-FACT "+url+" "+doc.metadata[i].rel+" "+doc.metadata[i].val);
            storeFact({
                subject: url,
                predicate: doc.metadata[i].rel,
                object: doc.metadata[i].val
            });
        }
    } catch(e) {
        log(e);
    }

    try {
        // store metadata for items and expand any catalogues
        for (var i=0;i<doc.items.length;i++) {
            var item = doc.items[i];
            item.href = URI(item.href).absoluteTo(url).toString();    // fixup relative URL
            // store that catalogue has an item
            storeFact({
                subject: url,
                predicate: "urn:X-tsbiot:rels:hasResource",
                object: item.href
            });
            for (var j=0;j<item.metadata.length;j++) {
                var mdata = item.metadata[j];
                //console.log("ITEM-FACT "+item.href+" "+mdata.rel+" "+mdata.val);
                storeFact({
                    subject: item.href,
                    predicate: mdata.rel,
                    object: mdata.val
                });

                // if we find a link to a catalogue, follow it
                if (mdata.rel == "urn:X-tsbiot:rels:isContentType" &&
                    mdata.val == "application/vnd.tsbiot.catalogue+json") {
                        unexplored.push(item.href);
                }
            }
        }
    } catch(e) {
        log(e);
    }
}

function crawl(cb) {
    if (unexplored.length > 0) {    // something to explore
        var url = unexplored.pop();

        if (explored.indexOf(url) == -1) {   // not seen before
            fetch(url, function(err, doc) {
                if (err) {
                    log("Error in "+url+" ("+err+")");
                    explored.push(url); // was bad, but explored
                    crawl(cb);
                } else {
                    explored.push(url);
                    expandCatalogue(url, doc);    // parse doc
                    crawl(cb);    // do some more work
                }
            });
        } else {
            crawl(cb);  // get next
        }
    } else {
        cb();   // done
    }
}

function dumpGraph(filterFunc) {
    graph.filterNodes(function(){return false});

    for (var i=0;i<facts.length;i++) {
        if (filterFunc === undefined || filterFunc(facts[i])) {
		    graph.addNodes(facts[i].subject);

            // If this does not look like a URI, make it a unique node
            var prefix = "";    // FIXME
            if (!facts[i].object.match("/^http/") && facts[i].object.match("/^mqtt/") && !facts[i].object.match(/"^urn:"/) && !facts[i].object.match(/^\//))
                prefix = facts[i].subject+facts[i].predicate;
console.log(prefix+facts[i].object);
            var node = new Springy.Node(prefix+facts[i].object, {label:facts[i].object});
            graph.addNode(node);
            graph.addEdges([facts[i].subject, prefix+facts[i].object, {label:facts[i].predicate}]);
        }
    }
}

// http://stackoverflow.com/questions/6940103/how-do-i-make-an-array-with-unique-elements-i-e-remove-duplicates
function ArrNoDupe(a) {
    var temp = {};
    for (var i = 0; i < a.length; i++)
        temp[a[i]] = true;
    var r = [];
    for (var k in temp)
        r.push(k);
    return r;
}

function populateForm() {
    var predicates = [];
    var objects = [];
    var subjects = [];
    for (var i=0;i<facts.length;i++) {
        predicates.push(facts[i].predicate);
        objects.push(facts[i].object);
        subjects.push(facts[i].subject);
    }
    predicates = ArrNoDupe(predicates);
    objects = ArrNoDupe(objects);
    subjects = ArrNoDupe(subjects);
    $("#predicates").html("");
    $("#objects").html("");
    $("#subjects").html("");
    for (var i=0;i<predicates.length;i++)
        $("#predicates").append(new Option(predicates[i], predicates[i]));
    for (var i=0;i<subjects.length;i++)
        $("#subjects").append(new Option(subjects[i], subjects[i]));
    for (var i=0;i<objects.length;i++)
        $("#objects").append(new Option(objects[i], objects[i]));

    $("#filter_all").removeAttr("disabled");
    $("#filter_by_predicate").removeAttr("disabled");
    $("#filter_by_object").removeAttr("disabled");
    $("#filter_by_subject").removeAttr("disabled");

    $("#render_map").removeAttr("disabled");
    $("#hide_map").removeAttr("disabled");
}

function startcrawl(url) {
    unexplored.push(url);
    crawl(function() {
        log('Crawling complete');
        dumpGraph();
        populateForm();
    });
}

// http://stackoverflow.com/questions/10214873/make-canvas-as-wide-and-as-high-as-parent
function fitToContainer(canvas){
    // Make it visually fill the positioned parent
    canvas.style.width ='100%';
    canvas.style.height='50%';
    // ...then set the internal size to match
    canvas.width  = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
}


function initMap() {
    var myOptions = {
        center: new google.maps.LatLng(0, 0),
        zoom: 2,
        mapTypeId: google.maps.MapTypeId.HYBRID
    };
    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
}

function createMarker(lat, long, title, contentString, i) {
console.log("createMarker", lat, long, title);
    markers[i] = new google.maps.Marker({
        position: new google.maps.LatLng(lat, long),
        map: map, 
        title:title
    });

    google.maps.event.addListener(markers[i], 'click', function() {
        infowindow.setContent(contentString);
        infowindow.open(map, markers[i]);
    });
}

function plotOnMap(locs) {
    for (var i=0;i<locs.length;i++) {
        contentString = '<table>';
        for (key in locs[i])
            contentString += '<tr><td>'+key+'</td><td>'+locs[i][key]+'</td></tr>';
        contentString += '</table>';
        createMarker(locs[i].latitude, locs[i].longitude, locs[i]['urn:X-tsbiot:rels:hasDescription:en'], contentString, markers.length);
    }
}



$(document).ready(function() { 
    populateExamples();

    $(".collapsibleContainer").collapsiblePanel();

    $('#examples').on('change', function (e) {
        var optionSelected = $("option:selected", this);
        var valueSelected = this.value;
        $('#url').val(this.value);
    });


    $("#crawl").click(function() {
        startcrawl($('#url').val());
    });
    $("#crawlreplace").click(function() {
        unexplored = [];
        explored = [];
        facts = []; // wipe known facts first
        startcrawl($('#url').val());
    });

    $("#filter_by_predicate").attr("disabled", "disabled");
    $("#filter_by_predicate").click(function() {
        dumpGraph(function(fact) {
            if (fact.predicate == $('#predicates option:selected').html())
                return true;
            return false;
        });
    });
    $("#filter_by_object").attr("disabled", "disabled");
    $("#filter_by_object").click(function() {
        dumpGraph(function(fact) {
            if (fact.object == $('#objects option:selected').html())
                return true;
            return false;
        });
    });
    $("#filter_by_subject").attr("disabled", "disabled");
    $("#filter_by_subject").click(function() {
        dumpGraph(function(fact) {
            if (fact.subject == $('#subjects option:selected').html())
                return true;
            return false;
        });
    });
    $("#filter_all").attr("disabled", "disabled");
    $("#filter_all").click(function() {
        dumpGraph();
    });

    $("#render_map").attr("disabled", "disabled");
    $("#render_map").click(function() {
        $('#map_canvas').show();
        initMap();
        plotOnMap(searchForLocations());
    });

    $("#hide_map").attr("disabled", "disabled");
    $("#hide_map").click(function() {
        $('#map_canvas').hide();
    });

    graph = new Springy.Graph({stiffness:10000, repulsion:10000, damping:2.0});
    springy = jQuery('#graph').springy({
        graph: graph,
        nodeSelected: function(node){
          console.log('Node selected: ' + JSON.stringify(node.data));
        }
    });

    var canvas = document.querySelector('canvas');
    fitToContainer(canvas);
});

// returns [{resource:,longitude:,latitude:}]
function searchForLocations() {
    var locs = {};
    for (var i=0;i<facts.length;i++) {
        if (locs[facts[i].subject] === undefined)
            locs[facts[i].subject] = {};

        if (facts[i].predicate == "http://www.w3.org/2003/01/geo/wgs84_pos#long")
            locs[facts[i].subject].longitude = facts[i].object;
        if (facts[i].predicate == "http://www.w3.org/2003/01/geo/wgs84_pos#lat")
            locs[facts[i].subject].latitude = facts[i].object;
        // INSERT LIST OF ALTERNATE ONTOLOGIES
    }
    // only return nodes we have long and lat for
    var ret = [];
    for (var key in locs) {
        if (locs[key].longitude !== undefined && locs[key].latitude !== undefined) {
            var o = {resource:key, longitude:locs[key].longitude, latitude:locs[key].latitude};
            // fill in any other known properties of this resource
            for (var i=0;i<facts.length;i++) {
                if (facts[i].subject == key)
                    o[facts[i].predicate] = facts[i].object;
            }
            ret.push(o);
        }
    }
    return ret;
}

</script>
</head>

<body>
    <h1>Catalogue Crawler</h1>
    <p>
        This is a crawler and visualisation tool for IoT catalogues in the application/vnd.tsbiot.catalogue.json format. Given a starting URL, it will crawl any linked catalogues then render a directed graph of discovered relationships. The nodes and edges shown in the graph can be filtered. As a demonstration of extracting data, items with locations may be plotted to a map.
    </p>
    <p>
        Select an example catalogue from the box below, or enter the URL of any public catalogue and click "crawl".<br>
        You may also browse the <a href="examples">example catalogue files</a>. For a description of what each catalogue shows, see <a href="examples/README.txt">examples/README.txt</a>.
    </p>

    <p>
        <form>
            <select id="examples"></select>
            URL:&nbsp;<input type="text" id="url" size=80 value="Select example from dropdown or type URL" />
            <input type="button" id="crawl" value="Crawl (and add to existing graph)" />
            <input type="button" id="crawlreplace" value="Crawl (and replace existing graph)" />
        </form>
    </p>

    <div class="collapsibleContainer" title="Filter graph (click to toggle)">
        <p>
            The filters act independently.<br/>
            The graph is in the form: <b>subject --predicate--&gt; object</b><br/>
            The urn:X-tsbiot:rels:hasResource is automatically added to connect each catalogue with its items<br/>

        </p>
        <p>
            <form>
                <table>
                    <tr>
                        <td><select id="subjects"></select></td>
                        <td><input type="button" id="filter_by_subject" value="Filter by subject (what do we know about X?)"/></td>
                    </tr>
                    <tr>
                        <td><select id="predicates"></select></td>
                        <td><input type="button" id="filter_by_predicate" value="Filter by predicate (who uses relationship Y?)"/></td>
                    </tr>
                    <tr>
                        <td><select id="objects"></select></td>
                        <td><input type="button" id="filter_by_object" value="Filter by object (who has a relationship to Z?)"/></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td><input type="button" id="filter_all" value="Remove filter"/></td>
                    </tr>
                </table>
            </form>
        </p>
    </div>

    <div class="collapsibleContainer" title="Map (click to toggle)">
        <form>
            <input type="button" id="render_map" value="Render map of current graph"/>
            <!--<input type="button" id="hide_map" value="Hide map"/>-->
        </form>
        <p>
            The map knows about: "http://www.w3.org/2003/01/geo/wgs84_pos#long" and "http://www.w3.org/2003/01/geo/wgs84_pos#lat"
            <div id="map_canvas" style="width:100%; height:100%; display:none"></div>
        </p>
    </div>


    <p>
        <i>Drag graph nodes around for a clearer view</i>
    </p>
    <p>
        <div id="canvascontainer">
            <canvas id="graph"/>
        </div>
    </p>

    <div class="collapsibleContainer" title="Activity and error log (click to toggle)">
        <p>
            <div id="log"></div>
        </p>
    </div>


    <hr>
    <p>
        Toby Jaffey <a href="mailto:toby@1248.io">toby@1248.io</a>
    </p>
</body>

</html>
